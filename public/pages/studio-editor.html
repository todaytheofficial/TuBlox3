<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tublox Studio Editor</title>
  <link rel="stylesheet" href="/css/studio-editor.css">
  <link rel="stylesheet" href="/css/shared.css">
  <link rel="icon" type="image/png" href="/img/studio.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app">
    <!-- TOP BAR -->
    <div id="editor-topbar">
      <div class="topbar-left">
        <button class="topbar-btn" id="btn-back" title="Back">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <span class="topbar-title" id="topbar-title">Untitled</span>
        <span class="topbar-saved" id="topbar-saved" style="display:none">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          Saved
        </span>
      </div>
      <div class="topbar-center">
        <button class="topbar-tool active" data-tool="select" title="Select (V)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
        </button>
        <button class="topbar-tool" data-tool="block" title="Block (B)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
        </button>
        <button class="topbar-tool" data-tool="move" title="Move (M)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
        </button>
      </div>
      <div class="topbar-right">
        <button class="topbar-btn" id="btn-explorer-toggle" title="Explorer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>
        </button>
        <button class="topbar-btn" id="btn-items-panel" title="Asset Store">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7h-4l-2-3H10L8 7H4a2 2 0 00-2 2v11a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2z"/><path d="M12 11v6M9 14h6"/></svg>
        </button>
        <button class="topbar-btn" id="btn-settings" title="Settings">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        </button>
        <button class="topbar-btn topbar-btn-save" id="btn-save" title="Save">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          <span class="topbar-btn-label">Save</span>
        </button>
        <button class="topbar-btn topbar-btn-publish" id="btn-publish" title="Publish">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>
          <span class="topbar-btn-label" id="publish-btn-label">Publish</span>
        </button>
      </div>
    </div>

    <canvas id="editor-canvas"></canvas>

    <!-- MOBILE BOTTOM BAR -->
    <div id="mobile-toolbar" class="mobile-toolbar">
      <button class="mob-tool active" data-tool="select" title="Select">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
      </button>
      <button class="mob-tool" data-tool="block" title="Block">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
      </button>
      <button class="mob-tool" data-tool="move" title="Move">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
      </button>
      <button class="mob-tool mob-action" id="mob-explorer" title="Explorer">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>
      </button>
      <button class="mob-tool mob-action" id="mob-save" title="Save">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
      </button>
      <button class="mob-tool mob-action" id="mob-menu" title="Menu">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
    </div>

    <!-- EXPLORER PANEL -->
    <div id="explorer-panel" class="explorer-panel" style="display:none">
      <div class="rp-header">
        <h3>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>
          Explorer
        </h3>
        <button class="rp-close" id="explorer-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="explorer-tree" id="explorer-tree">
        <div class="explorer-node explorer-root" id="explorer-root">
          <div class="explorer-node-header" data-expand="workspace">
            <svg class="explorer-arrow" width="10" height="10" viewBox="0 0 10 10"><polygon points="3,2 8,5 3,8" fill="currentColor"/></svg>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" style="margin-right:4px"><circle cx="12" cy="12" r="10"/></svg>
            <span>Workspace</span>
          </div>
          <div class="explorer-children" id="explorer-workspace-children">
            <div class="explorer-node">
              <div class="explorer-node-header explorer-leaf" id="explorer-settings-node">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2" style="margin-left:12px;margin-right:4px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4"/></svg>
                <span>Settings</span>
              </div>
            </div>
            <div class="explorer-node">
              <div class="explorer-node-header explorer-leaf" id="explorer-spawn-node">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" style="margin-left:12px;margin-right:4px"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span>SpawnPoint</span>
              </div>
            </div>
            <div class="explorer-node">
              <div class="explorer-node-header" data-expand="blocks">
                <svg class="explorer-arrow" width="10" height="10" viewBox="0 0 10 10"><polygon points="3,2 8,5 3,8" fill="currentColor"/></svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" style="margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                <span>Blocks</span>
                <span class="explorer-count" id="explorer-blocks-count">0</span>
              </div>
              <div class="explorer-children" id="explorer-blocks-list" style="display:none"></div>
            </div>
            <div class="explorer-node">
              <div class="explorer-node-header" data-expand="items">
                <svg class="explorer-arrow" width="10" height="10" viewBox="0 0 10 10"><polygon points="3,2 8,5 3,8" fill="currentColor"/></svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" style="margin-right:4px"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <span>Items</span>
                <span class="explorer-count" id="explorer-items-count">0</span>
              </div>
              <div class="explorer-children" id="explorer-items-list" style="display:none"></div>
            </div>
            <div class="explorer-node">
              <div class="explorer-node-header" data-expand="models">
                <svg class="explorer-arrow" width="10" height="10" viewBox="0 0 10 10"><polygon points="3,2 8,5 3,8" fill="currentColor"/></svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2" style="margin-right:4px"><rect x="2" y="6" width="20" height="14" rx="2"/></svg>
                <span>Models</span>
                <span class="explorer-count" id="explorer-models-count">0</span>
              </div>
              <div class="explorer-children" id="explorer-models-list" style="display:none"></div>
            </div>
            <div class="explorer-node">
              <div class="explorer-node-header" data-expand="avatars">
                <svg class="explorer-arrow" width="10" height="10" viewBox="0 0 10 10"><polygon points="3,2 8,5 3,8" fill="currentColor"/></svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2" style="margin-right:4px"><circle cx="12" cy="8" r="4"/><path d="M5 21a7 7 0 0114 0"/></svg>
                <span>Avatars</span>
                <span class="explorer-count" id="explorer-avatars-count">0</span>
              </div>
              <div class="explorer-children" id="explorer-avatars-list" style="display:none"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL (Properties) -->
    <div id="right-panel" class="right-panel" style="display:none">
      <div class="rp-header">
        <h3 id="rp-title">Properties</h3>
        <button class="rp-close" id="rp-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <!-- Block properties -->
      <div id="block-props">
        <div class="rp-section">
          <label>Position</label>
          <div class="rp-row">
            <div class="rp-field"><span>X</span><input type="number" id="prop-x"></div>
            <div class="rp-field"><span>Y</span><input type="number" id="prop-y"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>Size</label>
          <div class="rp-row">
            <div class="rp-field"><span>W</span><input type="number" id="prop-w" min="10"></div>
            <div class="rp-field"><span>H</span><input type="number" id="prop-h" min="10"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>Color</label>
          <div class="rp-row">
            <input type="color" id="prop-color" class="rp-color">
            <input type="text" id="prop-color-text" class="rp-color-text" maxlength="7">
          </div>
        </div>
        <div class="rp-section">
          <label>Opacity</label>
          <input type="range" id="prop-opacity" min="0" max="1" step="0.05" class="rp-slider">
          <span class="rp-slider-val" id="prop-opacity-val">1</span>
        </div>
        <div class="rp-section">
          <label>Text</label>
          <input type="text" id="prop-text" class="rp-input" maxlength="100">
          <div class="rp-row" style="margin-top:6px">
            <select id="prop-text-font" class="rp-select">
              <option value="Inter">Inter</option>
              <option value="monospace">Mono</option>
              <option value="serif">Serif</option>
              <option value="Arial">Arial</option>
            </select>
            <input type="number" id="prop-text-size" class="rp-input-sm" min="8" max="72">
            <input type="color" id="prop-text-color" class="rp-color-sm">
          </div>
        </div>
        <div class="rp-section">
          <div class="rp-checkbox">
            <input type="checkbox" id="prop-spawn">
            <label for="prop-spawn">Set as Spawn Point</label>
          </div>
        </div>
        <button class="btn btn-danger btn-full rp-delete" id="btn-delete-block">Delete Block</button>
      </div>

      <!-- Item properties -->
      <div id="item-props" style="display:none">
        <div class="rp-section">
          <label>Item Type</label>
          <div class="item-type-display" id="item-type-display"></div>
        </div>
        <div class="rp-section">
          <label>Position</label>
          <div class="rp-row">
            <div class="rp-field"><span>X</span><input type="number" id="item-x"></div>
            <div class="rp-field"><span>Y</span><input type="number" id="item-y"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>Behavior</label>
          <div class="rp-checkbox">
            <input type="checkbox" id="item-give-start">
            <label for="item-give-start">Give on game start</label>
          </div>
          <div class="rp-checkbox">
            <input type="checkbox" id="item-collect-touch">
            <label for="item-collect-touch">Collect on touch</label>
          </div>
        </div>
        <div id="item-custom-props" class="rp-section"></div>
        <button class="btn btn-danger btn-full rp-delete" id="btn-delete-item">Delete Item</button>
      </div>

      <!-- Model properties -->
      <div id="model-props" style="display:none">
        <div class="rp-section">
          <label>Model Type</label>
          <div class="item-type-display" id="model-type-display"></div>
        </div>
        <div class="rp-section">
          <label>Position</label>
          <div class="rp-row">
            <div class="rp-field"><span>X</span><input type="number" id="model-x"></div>
            <div class="rp-field"><span>Y</span><input type="number" id="model-y"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>Size</label>
          <div class="rp-row">
            <div class="rp-field"><span>W</span><input type="number" id="model-w" min="10"></div>
            <div class="rp-field"><span>H</span><input type="number" id="model-h" min="10"></div>
          </div>
        </div>
        <div id="model-custom-props" class="rp-section"></div>
        <button class="btn btn-danger btn-full rp-delete" id="btn-delete-model">Delete Model</button>
      </div>

      <!-- Avatar properties -->
      <div id="avatar-props" style="display:none">
        <div class="rp-section">
          <label>Avatar Placement</label>
          <div class="avatar-preview-box">
            <canvas id="avatar-preview-canvas" width="80" height="100"></canvas>
          </div>
        </div>
        <div class="rp-section">
          <label>Position</label>
          <div class="rp-row">
            <div class="rp-field"><span>X</span><input type="number" id="avatar-x"></div>
            <div class="rp-field"><span>Y</span><input type="number" id="avatar-y"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>Scale</label>
          <div class="rp-row">
            <div class="rp-field"><span>W</span><input type="number" id="avatar-w" min="10" value="22"></div>
            <div class="rp-field"><span>H</span><input type="number" id="avatar-h" min="10" value="34"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>Direction</label>
          <div class="rp-row">
            <button class="avatar-dir-btn active" data-dir="1" id="avatar-dir-right">→ Right</button>
            <button class="avatar-dir-btn" data-dir="-1" id="avatar-dir-left">← Left</button>
          </div>
        </div>
        <div class="settings-divider"></div>
        <h4 class="settings-section-title">Animation</h4>
        <div class="rp-section">
          <label>Default Animation</label>
          <select id="avatar-default-anim" class="rp-select">
            <option value="idle">Idle</option>
            <option value="run">Run</option>
            <option value="jump">Jump</option>
            <option value="dance">Dance</option>
            <option value="wave">Wave</option>
            <option value="sit">Sit</option>
            <option value="custom">Custom Keyframes</option>
          </select>
        </div>
        <div class="rp-section">
          <label>Animation Speed</label>
          <input type="range" id="avatar-anim-speed" min="0.1" max="3" step="0.1" value="1" class="rp-slider">
          <span class="rp-slider-val" id="avatar-anim-speed-val">1.0</span>
        </div>
        <div class="rp-section">
          <div class="rp-checkbox">
            <input type="checkbox" id="avatar-loop" checked>
            <label for="avatar-loop">Loop Animation</label>
          </div>
        </div>
<div class="rp-section">
  <div class="rp-checkbox">
    <input type="checkbox" id="avatar-interact">
    <label for="avatar-interact">Interactive (player can trigger)</label>
  </div>
</div>

<!-- DIALOGUE SCRIPT SECTION -->
<div id="avatar-dialogue-section" style="display:none">
  <div class="settings-divider"></div>
  <h4 class="settings-section-title">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px">
      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
    </svg>
    Dialogue Script
  </h4>
  <div class="rp-section">
    <label>Trigger Key</label>
    <select id="dialogue-trigger-key" class="rp-select">
      <option value="E">E (default)</option>
      <option value="F">F</option>
      <option value="Space">Space</option>
    </select>
  </div>
  <div class="rp-section">
    <label>Trigger Radius</label>
    <input type="range" id="dialogue-trigger-radius" min="30" max="300" step="10" value="80" class="rp-slider">
    <span class="rp-slider-val" id="dialogue-trigger-radius-val">80</span>
  </div>
  <div class="rp-section">
    <div class="rp-checkbox">
      <input type="checkbox" id="dialogue-one-time">
      <label for="dialogue-one-time">One-time dialogue (can't repeat)</label>
    </div>
  </div>
  <div class="rp-section">
    <label>NPC Name</label>
    <input type="text" id="dialogue-npc-name" class="rp-input" placeholder="e.g. Guard, Merchant..." maxlength="30">
  </div>
  <div class="rp-section">
    <label>Name Color</label>
    <input type="color" id="dialogue-name-color" value="#a78bfa" class="rp-color-sm">
  </div>
  <div class="rp-section">
    <label>Dialogue Lines</label>
    <div id="dialogue-lines-list" class="dialogue-lines-list"></div>
    <button class="btn btn-sm btn-outline-light" id="btn-add-dialogue-line" style="margin-top:6px;width:100%">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Line
    </button>
  </div>

  <div class="settings-divider"></div>
  <h4 class="settings-section-title">Choices (Branching)</h4>
  <div class="rp-section">
    <div class="rp-checkbox">
      <input type="checkbox" id="dialogue-has-choices">
      <label for="dialogue-has-choices">Enable player choices</label>
    </div>
  </div>
  <div id="dialogue-choices-section" style="display:none">
    <div class="rp-section">
      <label>Show choices after line #</label>
      <input type="number" id="dialogue-choice-after" class="rp-input-sm" min="1" value="1" style="width:60px">
    </div>
    <div class="rp-section">
      <label>Choice Prompt</label>
      <input type="text" id="dialogue-choice-prompt" class="rp-input" placeholder="What do you want to do?" maxlength="100">
    </div>
    <div id="dialogue-choices-list" class="dialogue-choices-list"></div>
    <button class="btn btn-sm btn-outline-light" id="btn-add-dialogue-choice" style="margin-top:6px;width:100%">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Choice
    </button>
  </div>

  <div class="settings-divider"></div>
  <h4 class="settings-section-title">Actions</h4>
  <div class="rp-section">
    <label>On Dialogue End</label>
    <select id="dialogue-end-action" class="rp-select">
      <option value="none">None</option>
      <option value="give_item">Give Item</option>
      <option value="remove_item">Remove Item</option>
      <option value="teleport">Teleport Player</option>
      <option value="open_door">Open Door/Model</option>
      <option value="set_variable">Set Variable</option>
      <option value="play_anim">Play Avatar Animation</option>
    </select>
  </div>
  <div id="dialogue-action-params" class="rp-section"></div>

  <div class="settings-divider"></div>
  <h4 class="settings-section-title">Conditions</h4>
  <div class="rp-section">
    <div class="rp-checkbox">
      <input type="checkbox" id="dialogue-has-condition">
      <label for="dialogue-has-condition">Require condition to start</label>
    </div>
  </div>
  <div id="dialogue-condition-section" style="display:none">
    <div class="rp-section">
      <label>Condition Type</label>
      <select id="dialogue-condition-type" class="rp-select">
        <option value="has_item">Player has item</option>
        <option value="no_item">Player doesn't have item</option>
        <option value="variable_equals">Variable equals</option>
        <option value="variable_gt">Variable greater than</option>
      </select>
    </div>
    <div id="dialogue-condition-params" class="rp-section"></div>
    <div class="rp-section">
      <label>If condition NOT met — alt dialogue</label>
      <textarea id="dialogue-condition-fail-text" class="rp-textarea" rows="2" placeholder="e.g. Come back when you have the key..." maxlength="300"></textarea>
    </div>
  </div>

  <div class="settings-divider"></div>
  <h4 class="settings-section-title">Preview</h4>
  <div class="rp-section">
    <button class="btn btn-sm btn-outline-light" id="btn-preview-dialogue" style="width:100%">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      Preview Dialogue
    </button>
  </div>
</div>
        <div id="avatar-custom-anim" style="display:none">
          <div class="settings-divider"></div>
          <h4 class="settings-section-title">Keyframes</h4>
          <div class="rp-section">
            <div class="keyframe-timeline" id="keyframe-timeline">
              <div class="keyframe-track" id="keyframe-track"></div>
            </div>
            <div class="keyframe-controls">
              <button class="btn btn-sm btn-outline-light" id="btn-add-keyframe">+ Keyframe</button>
              <button class="btn btn-sm btn-outline-light" id="btn-play-anim">▶ Preview</button>
            </div>
          </div>
          <div id="keyframe-props" style="display:none">
            <div class="rp-section">
              <label>Keyframe <span id="kf-index">0</span></label>
              <div class="rp-row">
                <div class="rp-field"><span>Time</span><input type="number" id="kf-time" step="0.1" min="0"></div>
                <div class="rp-field"><span>Dur</span><input type="number" id="kf-duration" step="0.1" min="0.1"></div>
              </div>
            </div>
            <div class="rp-section">
              <label>Pose</label>
              <select id="kf-pose" class="rp-select">
                <option value="idle">Idle</option>
                <option value="run">Run</option>
                <option value="jump">Jump</option>
                <option value="dance">Dance</option>
                <option value="wave">Wave</option>
                <option value="sit">Sit</option>
              </select>
            </div>
            <div class="rp-section">
              <label>Movement</label>
              <div class="rp-row">
                <div class="rp-field"><span>ΔX</span><input type="number" id="kf-dx" step="1"></div>
                <div class="rp-field"><span>ΔY</span><input type="number" id="kf-dy" step="1"></div>
              </div>
            </div>
            <div class="rp-section">
              <label>Direction</label>
              <select id="kf-dir" class="rp-select">
                <option value="0">Keep Current</option>
                <option value="1">Face Right</option>
                <option value="-1">Face Left</option>
              </select>
            </div>
            <div class="rp-section">
              <label>Easing</label>
              <select id="kf-easing" class="rp-select">
                <option value="linear">Linear</option>
                <option value="easeIn">Ease In</option>
                <option value="easeOut">Ease Out</option>
                <option value="easeInOut">Ease In-Out</option>
                <option value="bounce">Bounce</option>
              </select>
            </div>
            <button class="btn btn-danger btn-sm" id="btn-delete-keyframe" style="margin-top:6px">Delete Keyframe</button>
          </div>
        </div>
        <div class="settings-divider"></div>
        <div class="rp-section">
          <label>Avatar Colors</label>
          <div class="rp-row" style="margin-bottom:6px">
            <div class="rp-field"><span>Body</span><input type="color" id="avatar-body-color" value="#ffffff" class="rp-color-sm"></div>
            <div class="rp-field"><span>Head</span><input type="color" id="avatar-head-color" value="#ffffff" class="rp-color-sm"></div>
          </div>
          <div class="rp-row">
            <div class="rp-field"><span>Eyes</span><input type="color" id="avatar-eye-color" value="#000000" class="rp-color-sm"></div>
          </div>
        </div>
        <div class="rp-section">
          <div class="rp-checkbox">
            <input type="checkbox" id="avatar-use-player">
            <label for="avatar-use-player">Use Player's Own Avatar</label>
          </div>
        </div>
        <button class="btn btn-danger btn-full rp-delete" id="btn-delete-avatar">Delete Avatar</button>
      </div>
    </div>

    <!-- ITEMS PANEL / ASSET STORE -->
    <div id="items-panel" class="items-panel" style="display:none">
      <div class="rp-header">
        <h3>Asset Store</h3>
        <button class="rp-close" id="items-panel-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="items-filter">
        <button class="filter-btn active" data-cat="all">All</button>
        <button class="filter-btn" data-cat="weapon">Weapons</button>
        <button class="filter-btn" data-cat="tool">Tools</button>
        <button class="filter-btn" data-cat="powerup">Powerups</button>
        <button class="filter-btn" data-cat="collectible">Items</button>
        <button class="filter-btn" data-cat="model">Models</button>
        <button class="filter-btn" data-cat="avatar">Avatar</button>
      </div>
      <div id="asset-list" class="asset-list"></div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay" style="display:none">
      <div class="modal-panel modal-wide" style="max-height:85vh;overflow-y:auto">
        <h3>Game Settings</h3>
        <div class="rp-section"><label>Title</label><input type="text" id="set-title" class="rp-input" maxlength="50"></div>
        <div class="rp-section"><label>Description</label><textarea id="set-desc" class="rp-textarea" maxlength="200" rows="3"></textarea></div>
        <div class="rp-section"><label>Background Color</label><input type="color" id="set-bg" class="rp-color"></div>
        <div class="rp-section">
          <label>Physics</label>
          <div class="rp-row">
            <div class="rp-field"><span>Gravity</span><input type="number" id="set-gravity" step="0.1"></div>
            <div class="rp-field"><span>Speed</span><input type="number" id="set-speed" step="0.5"></div>
            <div class="rp-field"><span>Jump</span><input type="number" id="set-jump" step="0.5"></div>
          </div>
        </div>
        <div class="rp-section">
          <label>World Size</label>
          <div class="rp-row">
            <div class="rp-field"><span>W</span><input type="number" id="set-world-w"></div>
            <div class="rp-field"><span>H</span><input type="number" id="set-world-h"></div>
          </div>
        </div>
        <div class="settings-divider"></div>
        <h4 class="settings-section-title">Fog</h4>
        <div class="rp-section">
          <div class="rp-checkbox"><input type="checkbox" id="set-fog-enabled"><label for="set-fog-enabled">Enable Fog</label></div>
        </div>
        <div id="fog-settings" style="display:none">
          <div class="rp-section">
            <label>Fog Color</label>
            <div class="rp-row">
              <input type="color" id="set-fog-color" class="rp-color" value="#000000">
              <input type="text" id="set-fog-color-text" class="rp-color-text" maxlength="7" value="#000000">
            </div>
          </div>
          <div class="rp-section">
            <label>Density <span class="rp-slider-val" id="set-fog-density-val">0.5</span></label>
            <input type="range" id="set-fog-density" min="0" max="1" step="0.05" value="0.5" class="rp-slider">
          </div>
          <div class="rp-section">
            <label>Start <span class="rp-slider-val" id="set-fog-start-val">100</span></label>
            <input type="range" id="set-fog-start" min="0" max="500" step="10" value="100" class="rp-slider">
          </div>
          <div class="rp-section">
            <label>End <span class="rp-slider-val" id="set-fog-end-val">400</span></label>
            <input type="range" id="set-fog-end" min="50" max="1000" step="10" value="400" class="rp-slider">
          </div>
        </div>
        <div class="settings-divider"></div>
        <h4 class="settings-section-title">Darkness</h4>
        <div class="rp-section">
          <div class="rp-checkbox"><input type="checkbox" id="set-darkness"><label for="set-darkness">Enable Darkness</label></div>
        </div>
        <div id="darkness-settings" style="display:none">
          <div class="rp-section">
            <label>Ambient <span class="rp-slider-val" id="set-ambient-val">0.02</span></label>
            <input type="range" id="set-ambient" min="0" max="0.5" step="0.01" value="0.02" class="rp-slider">
          </div>
          <div class="rp-section">
            <label>Flashlight</label>
            <div class="rp-row">
              <div class="rp-field"><span>Radius</span><input type="number" id="set-fl-radius" value="220"></div>
              <div class="rp-field"><span>Bright</span><input type="number" id="set-fl-bright" step="0.1" value="1.2"></div>
            </div>
          </div>
          <div class="rp-section">
            <label>Spread <span class="rp-slider-val" id="set-fl-spread-val">0.45</span></label>
            <input type="range" id="set-fl-spread" min="0.1" max="1.5" step="0.05" value="0.45" class="rp-slider">
          </div>
          <div class="rp-section">
            <label>Battery</label>
            <div class="rp-row">
              <div class="rp-field"><span>Max</span><input type="number" id="set-bat-max" value="100"></div>
              <div class="rp-field"><span>Drain</span><input type="number" id="set-bat-drain" step="0.1" value="0.8"></div>
              <div class="rp-field"><span>Regen</span><input type="number" id="set-bat-regen" step="0.1" value="0.3"></div>
            </div>
          </div>
          <div class="rp-section">
            <label>Flicker <span class="rp-slider-val" id="set-flicker-val">0.003</span></label>
            <input type="range" id="set-flicker" min="0" max="0.05" step="0.001" value="0.003" class="rp-slider">
          </div>
        </div>
        <div class="settings-divider"></div>
        <h4 class="settings-section-title">Effects</h4>
        <div class="rp-section">
          <div class="rp-checkbox"><input type="checkbox" id="set-particles"><label for="set-particles">Particles</label></div>
          <div class="rp-checkbox"><input type="checkbox" id="set-breathing"><label for="set-breathing">Breathing</label></div>
          <div class="rp-checkbox"><input type="checkbox" id="set-footstep"><label for="set-footstep">Camera Shake</label></div>
          <div class="rp-checkbox"><input type="checkbox" id="set-vignette"><label for="set-vignette">Vignette</label></div>
        </div>
        <div id="vignette-settings" style="display:none">
          <div class="rp-section">
            <label>Intensity <span class="rp-slider-val" id="set-vignette-val">0.3</span></label>
            <input type="range" id="set-vignette-intensity" min="0" max="1" step="0.05" value="0.3" class="rp-slider">
          </div>
          <div class="rp-section"><label>Color</label><input type="color" id="set-vignette-color" class="rp-color" value="#000000"></div>
        </div>
        <div class="settings-divider"></div>
        <h4 class="settings-section-title">Tint</h4>
        <div class="rp-section">
          <div class="rp-checkbox"><input type="checkbox" id="set-tint-enabled"><label for="set-tint-enabled">Screen Tint</label></div>
        </div>
        <div id="tint-settings" style="display:none">
          <div class="rp-section"><label>Color</label><input type="color" id="set-tint-color" class="rp-color" value="#000000"></div>
          <div class="rp-section">
            <label>Opacity <span class="rp-slider-val" id="set-tint-opacity-val">0.1</span></label>
            <input type="range" id="set-tint-opacity" min="0" max="0.5" step="0.01" value="0.1" class="rp-slider">
          </div>
        </div>
        <div class="modal-buttons">
          <button class="btn btn-outline-light" id="btn-settings-cancel">Cancel</button>
          <button class="btn btn-white" id="btn-settings-save">Apply</button>
        </div>
      </div>
    </div>

    <!-- PUBLISH MODAL -->
    <div id="publish-modal" class="modal-overlay" style="display:none">
      <div class="modal-panel modal-wide">
        <h3 id="publish-modal-title">Publish TuGame</h3>
        <div class="rp-section"><label>Game Title</label><input type="text" id="pub-title" class="rp-input" maxlength="50"></div>
        <div class="rp-section"><label>Description</label><textarea id="pub-desc" class="rp-textarea" maxlength="200" rows="2"></textarea></div>
        <div class="rp-section">
          <label>Thumbnail</label>
          <div class="pub-thumb-area">
            <canvas id="pub-thumb-preview" width="360" height="200"></canvas>
            <div class="pub-thumb-actions">
              <button class="btn btn-outline-light btn-sm" id="pub-thumb-auto">Auto Generate</button>
              <label class="btn btn-outline-light btn-sm">
                Upload
                <input type="file" id="pub-thumb-upload" accept="image/*" style="display:none">
              </label>
            </div>
          </div>
        </div>
        <div class="rp-section">
          <label>Visibility</label>
          <div class="pub-vis-options">
            <button class="pub-vis-btn active" data-vis="public">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
              <span>Public</span>
              <small>Everyone can play</small>
            </button>
            <button class="pub-vis-btn" data-vis="private">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
              <span>Private</span>
              <small>Only you</small>
            </button>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="btn btn-outline-light" id="btn-pub-cancel">Cancel</button>
          <button class="btn btn-white" id="btn-pub-confirm">Publish</button>
        </div>
      </div>
    </div>

    <!-- MOBILE MENU -->
    <div id="mob-menu-overlay" class="modal-overlay" style="display:none">
      <div class="modal-panel">
        <h3>Menu</h3>
        <div class="modal-buttons-col">
          <button class="btn btn-white btn-full" id="mob-settings">Settings</button>
          <button class="btn btn-white btn-full" id="mob-items">Asset Store</button>
          <button class="btn btn-white btn-full" id="mob-publish">Publish</button>
          <button class="btn btn-outline-light btn-full" id="mob-back">Back to Studio</button>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/studio-editor.js"></script>
</body>
</html>